import requests
import json
from api.api_keys import malwarebazaar_api_key
from IPython.display import clear_output, HTML, display  # Added import


def get_malwarebazaar_hash_report(hash_id, status_output=None, progress_bar=None, as_dict=False):
    if status_output:
        with status_output:
            clear_output(wait=True)
            display(HTML(f'<b>Fetching MalwareBazaar report for hash: {hash_id}...</b>'))
            display(progress_bar)
    print(f"Fetching Hash report in Malwarebazaar for {hash_id}")    
    headers = {
        'API-KEY': malwarebazaar_api_key
    }
    data = {
        'query': 'get_info',
        'hash': hash_id,
    }
    response = requests.post('https://mb-api.abuse.ch/api/v1/', data=data, timeout=15, headers=headers)
    raw_json = response.json()

    # Debug print statement for raw JSON response
    #print(f"DEBUG: Raw JSON response from MalwareBazaar API: {raw_json}")

    if raw_json["query_status"] == 'hash_not_found':
        return None  # Returning None if no data found

    mb_report = raw_json["data"][0]

    # Return the raw data for further processing in the ioc_functions script
    return mb_report